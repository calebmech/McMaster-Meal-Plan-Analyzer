<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Meal Plan Analysis</title>
    <script src="func.js"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="bootstrap-reboot.min.css">
    <script src="https://unpkg.com/vue@2.4.4/dist/vue.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.0/Chart.bundle.min.js"></script> -->
</head>
<body>

<div id="app" class="wrapper">

<h1 class="text-center">McMaster Meal Plan Analyzer</h1>
<br>
<form id="form">
    <div class="card">
        <div class="card-header">
            <div class="container">
                <div class="row">
                    <div class="col-sm">
                            Copy and paste all data from your entire meal plan term at <a href="https://mealacct.mcmaster.ca/OneWeb/Financial/Transactions" target="_blank">Meal Plan Account</a> > Financial > Transations:
                    </div>
                    <div class="col-sm-auto">
                        <a href="#" class="badge badge-secondary" v-on:click="showHelp = !showHelp">Need help?</a>
                    </div>
                </div>
                <div class="row" v-if="showHelp">
                    <div class="card border-secondary mt-3">
                        <div class="card-body">
                            <h4 class="card-title">Data import instructions</h4>
                            <p class="card-text">
                                <ol>
                                    <li>
                                        Log on to your meal plan account using your Student number and PIN at <a href="https://mealacct.mcmaster.ca/OneWeb/Account/LogOn" target="_blank">https://mealacct.mcmaster.ca/OneWeb/Account/LogOn</a>.
                                        <br>
                                        <span class="font-italic text-muted">Please note that if you have not logged on before, you will have to create a PIN at Account Settings > <a href="https://mealacct.mcmaster.ca/OneWeb/Account/ResetPIN"> Reset Pin</a></span>
                                    </li>
                                    <li>
                                        Navigate to <a href="https://mealacct.mcmaster.ca/OneWeb/Financial/Transactions" target="_blank">https://mealacct.mcmaster.ca/OneWeb/Financial/Transactions</a>, or click Finanical > Transactions.
                                    </li>
                                    <li>
                                        Select a date range starting from before the school year until the current date. 
                                        <br>
                                        <span class="font-italic text-muted">The easiest way to do this is by changing the year in the "From" field to a year before the school year started (e.g. 2017 -> 2016)</span>
                                    </li>
                                    <li>
                                        Click on the magnifying glass icon. 
                                    </li>
                                    <li>
                                        Select the entire contents of the page and copy it to your clipboard using the shortcuts <span class="font-italic">Ctrl-A, Ctrl-C</span>.
                                        <br>
                                        <span class="font-italic text-muted">(&#8984; - A, &#8984; - C on a Mac)</span> 
                                    </li>
                                </ol>
                                
                                <button type="button" class="btn btn-outline-secondary btn-sm" v-on:click="showHelp = false">Close</button>
                            </p>
                        </div>    
                    </div>
                </div>
            </div>
            <!-- <button type="button" class="btn btn-outline-info">Need help?</button> -->
        </div>
        <div class="card-body">
            <div id="scrapper" class="form-group">
                <textarea name="rawTransactionData" class="form-control" id="rawTransactionData" cols="25 " rows="5" v-model="cpdata"></textarea>
            </div>
        </div>
    </div>
    <br>
    <div id="options">        
        <div class="form-group">
            <label for="mealPlanOptions">Meal Plan:</label>
            <select name="mealPlanOptions" id="mealPlanOptions" v-model="mealPlan" class="form-control">
                <option value="groupA.minimum">Group A - Minimum</option>
                <option value="groupA.light">Group A - Light</option>
                <option value="groupA.regular">Group A - Regular</option>
                <option value="groupA.varsity">Group A - Varsity</option>
                <option disabled="disabled">------------------------</option>
                <option value="groupB.minimum">Group B - Minimum</option>
                <option value="groupB.light">Group B - Light</option>
                <option value="groupB.regular">Group B - Regular</option>
                <option value="groupB.varsity">Group B - Varsity</option>
            </select>
        </div>
        <div class="form-group">
            <label for="prcntWeeksAway">Percentage of weekends away:</label>
            <div class="input-group">
                <input type="number" class="form-control" min="0" max="100" step="1" name="prcntWeekendsAway" id="prcntWeekendsAway" placeholder="25" v-model="prcntWeekendsAway">
                <span class="input-group-addon">%</span>
            </div>
        </div>
        <div class="form-group">
            <p>Reading weeks away:</p>
            <div class="form-check">
                <label class="form-check-label">
                    <input class="form-check-input" type="checkbox" name="awayFallReadingWeek" id="awayFallReadingWeek" v-model="readingWeekAwayF">
                    Fall reading week
                </label>
            </div>
            <div class="form-check">
                <label class="form-check-label">
                    <input class="form-check-input" type="checkbox" name="awayWinterReadingWeek" id="awayWinterReadingWeek" v-model="readingWeekAwayW">
                    Winter reading week
                </label>
            </div>
        </div>

        <transition name="bounce">
            <div class="card">
                <div class="card-header">
                    <a href="#" v-if="moreOptions" v-on:click.prevent="moreOptions = false">Fewer Options</a>
                    <a href="#" v-else v-on:click.prevent="moreOptions = true">More Options</a>
                </div>
                <div id="moreOptions" class="card-body" v-if="moreOptions">
                    <div class="form-group">
                        <label for="extraDaysAway">Extra Days Away:</label>
                        <input type="number" name="extraDaysAway" id="extraDaysAway" placeholder="0" v-model="numIndvDaysAway" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="lastExamDayFall">Last fall exam day:</label>
                        <input type="number" name="lastExamDayFall" id="lastExamDayFall" placeholder="Default: 21" v-model="lastExamDayF" class="form-control">
                        <label for="lastExamDayWinter">Last winter exam day:</label>
                        <input type="number" name="lastExamDayWinter" id="lastExamDayWinter" placeholder="Default: 26" v-model="lastExamDayW" class="form-control">
                    </div>
                </div>
            </div>
        </transition>
    </div>
</form>


<div id="output-data" v-if="cpdata">
        <hr id="io-seperator">

    <p class="h3" id="avgSpent">Average Spent Per Day: <span class="output" v-bind:style="{ color: spendingColor }">${{ avgSpent }}</span></p>
    <p class="h4" id="allowedSpending">You are allowed to spend <span class="output">${{ allowedSpending }}</span> per day</p>
    <br>
    <ul class="list-group">
        <li class="list-group-item">It costs you <span class="output">${{ costPerDay }}</span> to eat for a day</li>
        <li class="list-group-item">You have spent <span class="output">${{ totalSpent }}</span> in total</li>
        <li class="list-group-item">You have <span class="output">${{ initialBalance - totalSpent }}</span> remaining</li>
        <li v-if="remainingAmountAvg > 0" class="list-group-item">If you continue with your current spending, you will have <span class="output">${{ remainingAmountAvg }}</span> remaining at the end of the year</li>
        <li v-else class="list-group-item">If you continue with your current spending, you will need to add <span class="output">${{ -remainingAmountAvg }}</span> to your account</li>
    </ul>
    <!-- <p>It costs you <span class="output">${{ costPerDay }}</span> to eat for a day</p>
    <p>You have spent <span class="output">${{ totalSpent }}</span> in total</p>
    <p>You have <span class="output">${{ initialBalance - totalSpent }}</span> remaining</p>
    <p v-if="remainingAmountAvg > 0">If you continue with your current spending, you will have <span class="output">${{ remainingAmountAvg }}</span> remaining at the end of the year</p>
    <p v-else>If you continue with your current spending, you will need to add <span class="output">${{ -remainingAmountAvg }}</span> to your account</p> -->
    <!-- <p>{{ locations }}</p> -->
    <!-- <canvas id="locationVisitDistribution"></canvas> -->

</div>

</div>

<footer id="mainFooter">
    <div id="mainFooterWrapper">
        <p>Created by Caleb Mech | <a href="https://github.com/cmech/McMaster-Meal-Plan-Analyzer">GitHub</a> </p> 
        <p><span class="text-muted font-italic"> I am not responsible for any misinformation that you may recieve while using this site. </span></p>

    </div>
    
</footer>

<script>

var vm = new Vue({
    el: '#app',
    data: {
        cpdata: "",
        mealPlan: "groupA.minimum",
        prcntWeekendsAway: 10,
        readingWeekAwayF: true,
        readingWeekAwayW: true,
        numIndvDaysAway: 0,
        lastExamDayF: 21,
        lastExamDayW: 26,
        numWeekendsAway: 0,
        payingDays: 0,
        moreOptions: false,
        showHelp: false
    },
    computed: {
        initialBalance: function() {
            return mealPlanAmounts[this.mealPlan.split(".")[0]][this.mealPlan.split(".")[1]];
        },
        trns: function() {
            var data = this.cpdata
                     
            var date = data.match(/\d{2}\/\d{2}\/\d{4}/g);
            var time = data.match(/\d{1,2}:\d{2}:\d{2} (?:PM|AM)/g);
            var amount = data.match(/-\$\d{1,}.\d{2}/g);
            var place = data.match(/[0-9]{5} : [A-Z]{1,}/g);
            
            var numTrns = amount.length;

            var trns = [];

            for (i = 0; i < numTrns; i++) { 
                if(place[i].slice(8) != "FABO") {
                    trns.push({ 
                        date: date[i+2], 
                        time: time[i],
                        amount: amount[i],
                        place: place[i].slice(8) // Fix this hack with regex
                    });
                }
            };

            trns.reverse();
            return trns;
        },
        totalSpent: function() {
            var totalSpent = 0;
            this.trns.forEach(function(transation) {
                if(transation.amount[0] === "-") {
                    totalSpent += parseFloat(transation.amount.slice(2)) * 2;
                }
            });
            totalSpent = totalSpent.toFixed(2);
            return totalSpent;
        },
        avgSpent: function() {
            var stmntStartDate = Date.parse(this.trns[0].date);
            var stmntEndDate = new Date;

            var stmntLength = Math.ceil(elapsedDays(stmntStartDate, stmntEndDate));

            // Calculate Average Spent per Day

            var avgSpent = this.totalSpent / stmntLength;
            var avgSpent = avgSpent.toFixed(2);
            return avgSpent;
        },
        allowedSpending: function() {
            var startDateF = new Date(2017, 08, 05).getTime();
            var endDateF = new Date(2017, 11, this.lastExamDayF).getTime();
            var startDateW = new Date(2018, 01, 04).getTime();
            var endDateW = new Date(2018, 04, this.lastExamDayW).getTime();

            var totalDays = elapsedDays(startDateF, endDateF) + elapsedDays(startDateW, endDateW);

            var numWeeksTotal = Math.floor(totalDays / 7);
            this.numWeekendsAway = numWeeksTotal * this.prcntWeekendsAway/100;
            var numDaysAway = (this.numWeekendsAway*2) + this.numIndvDaysAway + this.readingWeekAwayF*9 + this.readingWeekAwayW*9;
            this.payingDays = totalDays - numDaysAway;
            var allowedSpending = this.initialBalance / this.payingDays;

            return allowedSpending.toFixed(2);
        },
        spendingColor: function() {
            spendingColor = "black";
            if (this.avgSpent < this.allowedSpending*0.85) {
                spendingColor = "green";
            } else if (this.avgSpent <= this.allowedSpending) {
                spendingColor = "orange";
            } else {
                spendingColor = "red";
            }
            return spendingColor;
        },
        remainingAmountAvg: function() {
            var remainingAmountAvg = this.initialBalance - this.costPerDay*this.payingDays
            return remainingAmountAvg.toFixed(2);
        },
        activeDays: function() {
            var activeDays = 1;
            var previousDate = this.trns[0].date;

            for(i = 0; i < this.trns.length; i++) {
                if(this.trns[i].date != previousDate) {
                    var previousDate = this.trns[i].date;
                    activeDays++;
                }
            }
            return activeDays;
        },
        costPerDay: function() {
            var costPerDay = this.totalSpent / this.activeDays;
            return costPerDay.toFixed(2);
        },
        locations: function() {

            var locations = [];

            for(i = 0; i < this.trns.length; i++) {
                for(x = 0; x < locations.length; x++) {
                    var match = false;
                    if(this.trns[i].place == locations[x].location) {
                        locations[x].timesVisited++;
                        match = true;
                        break;
                    }
                }
                if(!match) {
                    locations[locations.length] = {
                        "location": this.trns[i].place,
                        "timesVisited": 1
                    }
                }
            }
            return locations;
        }

    }
});

</script>

<!-- <script src="charts.js"></script> -->
</body>
</html>